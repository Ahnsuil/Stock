events {
    worker_connections 1024;
}

http {
    # Allow any localhost port for CORS (Vite may use 5173, 5174, 5175, etc.)
    map $http_origin $cors_origin {
        default "http://localhost:5173";
        "~^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$" $http_origin;
    }

    server {
        listen 80;
        server_name localhost;
        # Docker embedded DNS â€“ re-resolve upstream when supabase-rest restarts (avoids 502)
        resolver 127.0.0.11 valid=10s;

        # Route /rest/v1/* to PostgREST (strip /rest/v1 prefix)
        location /rest/v1/ {
            set $pgrst supabase-rest:3000;
            # Handle preflight OPTIONS requests first
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $cors_origin always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Accept, Accept-Language, Content-Language, Content-Type, Authorization, apikey, Prefer, x-client-info, accept-profile, content-profile' always;
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # CORS headers for all other requests
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PATCH, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Accept, Accept-Language, Content-Language, Content-Type, Authorization, apikey, Prefer, x-client-info, accept-profile, content-profile' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Range, Range' always;

            # Strip /rest/v1 so PostgREST gets /table (explicit path: variable in proxy_pass can skip rewritten URI)
            rewrite ^/rest/v1/?(.*)$ /$1 break;
            proxy_pass http://$pgrst/$1$is_args$args;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Remove CORS headers from upstream to avoid duplicates
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';
        }

        # Also allow direct access to PostgREST (for /rest/v1 paths)
        location / {
            # Handle preflight OPTIONS requests first
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' $cors_origin always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Accept, Accept-Language, Content-Language, Content-Type, Authorization, apikey, Prefer, x-client-info, accept-profile, content-profile' always;
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Type' 'text/plain; charset=utf-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # CORS headers for all other requests
            add_header 'Access-Control-Allow-Origin' $cors_origin always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PATCH, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Accept, Accept-Language, Content-Language, Content-Type, Authorization, apikey, Prefer, x-client-info, accept-profile, content-profile' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Range, Range' always;

            set $pgrst supabase-rest:3000;
            proxy_pass http://$pgrst;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Remove CORS headers from upstream to avoid duplicates
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';
        }
    }
}
